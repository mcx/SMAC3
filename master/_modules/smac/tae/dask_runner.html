<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>smac.tae.dask_runner &mdash; SMAC 1.0.1 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> SMAC
            <img src="../../../_static/SMAC3.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/quickstart/quickstart_example.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_recomendation.html">Usage Recommendation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../smac_examples.html">SMAC Examples</a><ul>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../manual.html">Manual</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../basic_usage.html">Basic Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../options.html">Options and file formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tae.html">Target Algorithm Evaluator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../psmac.html">Parallel SMAC (pSMAC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../validation.html">Validation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.callbacks.html">smac.callbacks module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.configspace.html">smac.configspace package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.configspace.util.html">smac.configspace.util module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.epm.html">smac.epm package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.base_epm.html">smac.epm.base_epm module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.base_gp.html">smac.epm.base_gp module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.base_imputor.html">smac.epm.base_imputor module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.base_rf.html">smac.epm.base_rf module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.gaussian_process.html">smac.epm.gaussian_process module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.gaussian_process_mcmc.html">smac.epm.gaussian_process_mcmc module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.gp_base_prior.html">smac.epm.gp_base_prior module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.gp_kernels.html">smac.epm.gp_kernels module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.random_epm.html">smac.epm.random_epm module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.rf_with_instances.html">smac.epm.rf_with_instances module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.rfr_imputator.html">smac.epm.rfr_imputator module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.uncorrelated_mo_rf_with_instances.html">smac.epm.uncorrelated_mo_rf_with_instances module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.epm.util_funcs.html">smac.epm.util_funcs module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.facade.html">smac.facade package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.facade.experimental.html">smac.facade.experimental package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../apidoc/smac.facade.experimental.hydra_facade.html">smac.facade.experimental.hydra_facade module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apidoc/smac.facade.experimental.psmac_facade.html">smac.facade.experimental.psmac_facade module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.facade.func_facade.html">smac.facade.func_facade module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.facade.hyperband_facade.html">smac.facade.hyperband_facade module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.facade.roar_facade.html">smac.facade.roar_facade module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.facade.smac_ac_facade.html">smac.facade.smac_ac_facade module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.facade.smac_bb_facade.html">smac.facade.smac_bb_facade module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.facade.smac_hpo_facade.html">smac.facade.smac_hpo_facade module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.facade.smac_mf_facade.html">smac.facade.smac_mf_facade module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.initial_design.html">smac.initial_design package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.initial_design.default_configuration_design.html">smac.initial_design.default_configuration_design module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.initial_design.factorial_design.html">smac.initial_design.factorial_design module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.initial_design.initial_design.html">smac.initial_design.initial_design module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.initial_design.latin_hypercube_design.html">smac.initial_design.latin_hypercube_design module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.initial_design.random_configuration_design.html">smac.initial_design.random_configuration_design module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.initial_design.sobol_design.html">smac.initial_design.sobol_design module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.intensification.html">smac.intensification package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.intensification.abstract_racer.html">smac.intensification.abstract_racer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.intensification.hyperband.html">smac.intensification.hyperband module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.intensification.intensification.html">smac.intensification.intensification module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.intensification.parallel_scheduling.html">smac.intensification.parallel_scheduling module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.intensification.simple_intensifier.html">smac.intensification.simple_intensifier module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.intensification.successive_halving.html">smac.intensification.successive_halving module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.optimizer.html">smac.optimizer package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.optimizer.acquisition.html">smac.optimizer.acquisition module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.optimizer.ei_optimization.html">smac.optimizer.ei_optimization module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.optimizer.epm_configuration_chooser.html">smac.optimizer.epm_configuration_chooser module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.optimizer.pSMAC.html">smac.optimizer.pSMAC module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.optimizer.random_configuration_chooser.html">smac.optimizer.random_configuration_chooser module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.optimizer.smbo.html">smac.optimizer.smbo module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.runhistory.html">smac.runhistory package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.runhistory.runhistory.html">smac.runhistory.runhistory module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.runhistory.runhistory2epm.html">smac.runhistory.runhistory2epm module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.scenario.html">smac.scenario package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.scenario.scenario.html">smac.scenario.scenario module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.stats.html">smac.stats package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.stats.stats.html">smac.stats.stats module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.tae.html">smac.tae package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.tae.base.html">smac.tae.base module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.tae.dask_runner.html">smac.tae.dask_runner module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.tae.execute_func.html">smac.tae.execute_func module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.tae.execute_ta_run_aclib.html">smac.tae.execute_ta_run_aclib module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.tae.execute_ta_run_hydra.html">smac.tae.execute_ta_run_hydra module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.tae.execute_ta_run_old.html">smac.tae.execute_ta_run_old module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.tae.serial_runner.html">smac.tae.serial_runner module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.utils.html">smac.utils package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.utils.io.html">smac.utils.io package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../apidoc/smac.utils.io.cmd_reader.html">smac.utils.io.cmd_reader module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apidoc/smac.utils.io.input_reader.html">smac.utils.io.input_reader module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apidoc/smac.utils.io.output_directory.html">smac.utils.io.output_directory module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apidoc/smac.utils.io.output_writer.html">smac.utils.io.output_writer module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../apidoc/smac.utils.io.traj_logging.html">smac.utils.io.traj_logging module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.utils.constants.html">smac.utils.constants module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.utils.dependencies.html">smac.utils.dependencies module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.utils.logging.html">smac.utils.logging module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.utils.merge_foreign_data.html">smac.utils.merge_foreign_data module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.utils.test_helpers.html">smac.utils.test_helpers module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../apidoc/smac.utils.validate.html">smac.utils.validate module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../apidoc/smac.smac_cli.html">smac.smac_cli module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">F.A.Q.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contact.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SMAC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
          <li><a href="../tae.html">smac.tae</a> &raquo;</li>
      <li>smac.tae.dask_runner</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for smac.tae.dask_runner</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">Future</span><span class="p">,</span> <span class="n">wait</span>

<span class="kn">from</span> <span class="nn">smac.configspace</span> <span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">smac.runhistory.runhistory</span> <span class="kn">import</span> <span class="n">RunInfo</span><span class="p">,</span> <span class="n">RunValue</span>
<span class="kn">from</span> <span class="nn">smac.tae</span> <span class="kn">import</span> <span class="n">StatusType</span>
<span class="kn">from</span> <span class="nn">smac.tae.base</span> <span class="kn">import</span> <span class="n">BaseRunner</span>

<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2021, AutoML.org Freiburg-Hannover&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;3-clause BSD&quot;</span>


<div class="viewcode-block" id="DaskParallelRunner"><a class="viewcode-back" href="../../../apidoc/smac.tae.dask_runner.html#smac.tae.dask_runner.DaskParallelRunner">[docs]</a><span class="k">class</span> <span class="nc">DaskParallelRunner</span><span class="p">(</span><span class="n">BaseRunner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interface to submit and collect a job in a distributed fashion.</span>

<span class="sd">    DaskParallelRunner is intended to comply with the bridge design pattern.</span>

<span class="sd">    Nevertheless, to reduce the amount of code within single-vs-parallel</span>
<span class="sd">    implementations, DaskParallelRunner wraps a BaseRunner object which</span>
<span class="sd">    is then executed in parallel on n_workers.</span>

<span class="sd">    This class then is constructed by passing a BaseRunner that implements</span>
<span class="sd">    a run() method, and is capable of doing so in a serial fashion. Then,</span>
<span class="sd">    this wrapper class called DaskParallelRunner uses dask to initialize</span>
<span class="sd">    N number of BaseRunner that actively wait of a RunInfo to produce a</span>
<span class="sd">    RunValue object.</span>

<span class="sd">    To be more precise, the work model is then:</span>
<span class="sd">    1.  The smbo.intensifier dictates &quot;what&quot; to run (a configuration/instance/seed)</span>
<span class="sd">        via a RunInfo object.</span>
<span class="sd">    2.  a tae_runner takes this RunInfo object and launches the task via</span>
<span class="sd">        tae_runner.submit_run(). In the case of DaskParallelRunner, n_workers</span>
<span class="sd">        receive a pickle-object of DaskParallelRunner.single_worker, each with a</span>
<span class="sd">        run() method coming from DaskParallelRunner.single_worker.run()</span>
<span class="sd">    3.  RunInfo objects are run in a distributed fashion, an their results are</span>
<span class="sd">        available locally to each worker. Such result is collected by</span>
<span class="sd">        DaskParallelRunner.get_finished_runs() and then passed to the SMBO.</span>
<span class="sd">    4.  Exceptions are also locally available to each worker and need to be</span>
<span class="sd">        collected.</span>

<span class="sd">    Dask works with Future object which are managed via the DaskParallelRunner.client.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">single_worker</span><span class="p">:</span> <span class="n">BaseRunner</span><span class="p">,</span>
        <span class="n">n_workers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">patience</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">output_directory</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dask_client</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">dask</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">Client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        results</span>
<span class="sd">        ta</span>
<span class="sd">        stats</span>
<span class="sd">        run_obj</span>
<span class="sd">        par_factor</span>
<span class="sd">        cost_for_crash</span>
<span class="sd">        abort_i_first_run_crash</span>
<span class="sd">        n_workers</span>
<span class="sd">        futures</span>
<span class="sd">        client</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        single_worker: BaseRunner</span>
<span class="sd">            A runner to run in a distributed fashion</span>
<span class="sd">        n_workers: int</span>
<span class="sd">            Number of workers to use for distributed run. Will be ignored if ``dask_client`` is not ``None``.</span>
<span class="sd">        patience: int</span>
<span class="sd">            How much to wait for workers to be available if one fails</span>
<span class="sd">        output_directory: str, optional</span>
<span class="sd">            If given, this will be used for the dask worker directory and for storing server information.</span>
<span class="sd">            If a dask client is passed, it will only be used for storing server information as the</span>
<span class="sd">            worker directory must be set by the program/user starting the workers.</span>
<span class="sd">        dask_client: dask.distributed.Client</span>
<span class="sd">            User-created dask client, can be used to start a dask cluster and then attach SMAC to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DaskParallelRunner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">ta</span><span class="o">=</span><span class="n">single_worker</span><span class="o">.</span><span class="n">ta</span><span class="p">,</span>
            <span class="n">stats</span><span class="o">=</span><span class="n">single_worker</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span>
            <span class="n">run_obj</span><span class="o">=</span><span class="n">single_worker</span><span class="o">.</span><span class="n">run_obj</span><span class="p">,</span>
            <span class="n">par_factor</span><span class="o">=</span><span class="n">single_worker</span><span class="o">.</span><span class="n">par_factor</span><span class="p">,</span>
            <span class="n">cost_for_crash</span><span class="o">=</span><span class="n">single_worker</span><span class="o">.</span><span class="n">cost_for_crash</span><span class="p">,</span>
            <span class="n">abort_on_first_run_crash</span><span class="o">=</span><span class="n">single_worker</span><span class="o">.</span><span class="n">abort_on_first_run_crash</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># The single worker, which is replicated on a need</span>
        <span class="c1"># basis to every compute node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single_worker</span> <span class="o">=</span> <span class="n">single_worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span> <span class="o">=</span> <span class="n">n_workers</span>

        <span class="c1"># How much time to wait for workers to be available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="n">output_directory</span>

        <span class="c1"># Because a run() method can have pynisher, we need to prevent the multiprocessing</span>
        <span class="c1"># workers to be instantiated as demonic - this cannot be passed via worker_kwargs</span>
        <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">({</span><span class="s1">&#39;distributed.worker.daemon&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">dask_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_client_at_del</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_workers</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">local_directory</span><span class="o">=</span><span class="n">output_directory</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;.dask_scheduler_file&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">write_scheduler_file</span><span class="p">(</span><span class="n">scheduler_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_client_at_del</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">dask_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: typing.List[Future]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">_get_scheduler_info</span><span class="p">()</span>

<div class="viewcode-block" id="DaskParallelRunner.submit_run"><a class="viewcode-back" href="../../../apidoc/smac.tae.dask_runner.html#smac.tae.dask_runner.DaskParallelRunner.submit_run">[docs]</a>    <span class="k">def</span> <span class="nf">submit_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_info</span><span class="p">:</span> <span class="n">RunInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This function submits a configuration</span>
<span class="sd">        embedded in a run_info object, and uses one of the workers</span>
<span class="sd">        to produce a result locally to each worker.</span>

<span class="sd">        The execution of a configuration follows this procedure:</span>
<span class="sd">        1.  SMBO/intensifier generates a run_info</span>
<span class="sd">        2.  SMBO calls submit_run so that a worker launches the run_info</span>
<span class="sd">        3.  submit_run internally calls self.run(). it does so via a call to self.run_wrapper()</span>
<span class="sd">        which contains common code that any run() method will otherwise have to implement, like</span>
<span class="sd">        capping check.</span>

<span class="sd">        Child classes must implement a run() method.</span>
<span class="sd">        All results will be only available locally to each worker, so the</span>
<span class="sd">        main node needs to collect them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        run_info: RunInfo</span>
<span class="sd">            An object containing the configuration and the necessary data to run it</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check for resources or block till one is available</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workers_available</span><span class="p">():</span>
            <span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="s1">&#39;FIRST_COMPLETED&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">done</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_completed_runs_from_futures</span><span class="p">()</span>

        <span class="c1"># In code check to make sure that there are resources</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workers_available</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No workers are available. This could mean workers crashed&quot;</span>
                          <span class="s2">&quot;Waiting for new workers...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_workers_available</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tried to execute a job, but no worker was &quot;</span>
                                 <span class="s2">&quot;available. This likely means that a worker crashed &quot;</span>
                                 <span class="s2">&quot;or no workers were properly configured.&quot;</span>
                                 <span class="p">)</span>

        <span class="c1"># At this point we can submit the job</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">single_worker</span><span class="o">.</span><span class="n">run_wrapper</span><span class="p">,</span>
                <span class="n">run_info</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DaskParallelRunner.get_finished_runs"><a class="viewcode-back" href="../../../apidoc/smac.tae.dask_runner.html#smac.tae.dask_runner.DaskParallelRunner.get_finished_runs">[docs]</a>    <span class="k">def</span> <span class="nf">get_finished_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">RunInfo</span><span class="p">,</span> <span class="n">RunValue</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;This method returns any finished configuration, and returns a list with</span>
<span class="sd">        the results of exercising the configurations. This class keeps populating results</span>
<span class="sd">        to self.results until a call to get_finished runs is done. In this case, the</span>
<span class="sd">        self.results list is emptied and all RunValues produced by running run() are</span>
<span class="sd">        returned.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            List[RunInfo, RunValue]: A list of RunValues (and respective RunInfo), that is,</span>
<span class="sd">                the results of executing a run_info</span>
<span class="sd">            a submitted configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Proactively see if more configs have finished</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extract_completed_runs_from_futures</span><span class="p">()</span>

        <span class="n">results_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">results_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">results_list</span></div>

<div class="viewcode-block" id="DaskParallelRunner._extract_completed_runs_from_futures"><a class="viewcode-back" href="../../../apidoc/smac.tae.dask_runner.html#smac.tae.dask_runner.DaskParallelRunner._extract_completed_runs_from_futures">[docs]</a>    <span class="k">def</span> <span class="nf">_extract_completed_runs_from_futures</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A run is over, when a future has done() equal true.</span>
<span class="sd">        This function collects the completed futures and move</span>
<span class="sd">        them from self.futures to self.results.</span>

<span class="sd">        We make sure futures never exceed the capacity of</span>
<span class="sd">        the scheduler</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># In code check to make sure we don;t exceed resource allocation</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">nthreads</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;More running jobs than resources available &quot;</span>
                          <span class="s2">&quot;Should not have more futures/runs in remote workers &quot;</span>
                          <span class="s2">&quot;than the number of workers. This could mean a worker &quot;</span>
                          <span class="s2">&quot;crashed and was not able to be recovered by dask. &quot;</span>
                          <span class="p">)</span>

        <span class="c1"># A future is removed to the list of futures as an indication</span>
        <span class="c1"># that a worker is available to take in an extra job</span>
        <span class="n">done_futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">done_futures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">future</span><span class="p">)</span></div>

<div class="viewcode-block" id="DaskParallelRunner.wait"><a class="viewcode-back" href="../../../apidoc/smac.tae.dask_runner.html#smac.tae.dask_runner.DaskParallelRunner.wait">[docs]</a>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;SMBO/intensifier might need to wait for runs to finish before making a decision.</span>
<span class="sd">        This class waits until 1 run completes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">:</span>
            <span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="s1">&#39;FIRST_COMPLETED&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">done</span></div>

<div class="viewcode-block" id="DaskParallelRunner.pending_runs"><a class="viewcode-back" href="../../../apidoc/smac.tae.dask_runner.html#smac.tae.dask_runner.DaskParallelRunner.pending_runs">[docs]</a>    <span class="k">def</span> <span class="nf">pending_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whether or not there are configs still running. Generally if the runner is serial,</span>
<span class="sd">        launching a run instantly returns it&#39;s result. On parallel runners, there might</span>
<span class="sd">        be pending configurations to complete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If there are futures available, it translates</span>
        <span class="c1"># to runs still not finished/processed</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="DaskParallelRunner.run"><a class="viewcode-back" href="../../../apidoc/smac.tae.dask_runner.html#smac.tae.dask_runner.DaskParallelRunner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Configuration</span><span class="p">,</span>
        <span class="n">instance</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">,</span>
        <span class="n">budget</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">instance_specific</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">StatusType</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method only complies with the abstract parent class. In the parallel case,</span>
<span class="sd">        we call the single worker run() method</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            config : Configuration</span>
<span class="sd">                dictionary param -&gt; value</span>
<span class="sd">            instance : string</span>
<span class="sd">                problem instance</span>
<span class="sd">            cutoff : float, optional</span>
<span class="sd">                Wallclock time limit of the target algorithm. If no value is</span>
<span class="sd">                provided no limit will be enforced.</span>
<span class="sd">            seed : int</span>
<span class="sd">                random seed</span>
<span class="sd">            budget : float, optional</span>
<span class="sd">                A positive, real-valued number representing an arbitrary limit to the target</span>
<span class="sd">                algorithm. Handled by the target algorithm internally</span>
<span class="sd">            instance_specific: str</span>
<span class="sd">                instance specific information (e.g., domain file or solution)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            status: enum of StatusType (int)</span>
<span class="sd">                {SUCCESS, TIMEOUT, CRASHED, ABORT}</span>
<span class="sd">            cost: float</span>
<span class="sd">                cost/regret/quality (float) (None, if not returned by TA)</span>
<span class="sd">            runtime: float</span>
<span class="sd">                runtime (None if not returned by TA)</span>
<span class="sd">            additional_info: dict</span>
<span class="sd">                all further additional run information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">single_worker</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">budget</span><span class="o">=</span><span class="n">budget</span><span class="p">,</span>
            <span class="n">instance_specific</span><span class="o">=</span><span class="n">instance_specific</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DaskParallelRunner.num_workers"><a class="viewcode-back" href="../../../apidoc/smac.tae.dask_runner.html#smac.tae.dask_runner.DaskParallelRunner.num_workers">[docs]</a>    <span class="k">def</span> <span class="nf">num_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Total number of workers available. This number is dynamic</span>
<span class="sd">        as more resources can be allocated&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">nthreads</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>

<div class="viewcode-block" id="DaskParallelRunner._workers_available"><a class="viewcode-back" href="../../../apidoc/smac.tae.dask_runner.html#smac.tae.dask_runner.DaskParallelRunner._workers_available">[docs]</a>    <span class="k">def</span> <span class="nf">_workers_available</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;&quot;Query if there are workers available, which means</span>
<span class="sd">        that there are resources to launch a dask job&quot;&quot;&quot;</span>
        <span class="n">total_compute_power</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">nthreads</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">total_compute_power</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make sure that when this object gets deleted, the client is terminated. This is only done if</span>
<span class="sd">        the client was created by the dask runner.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_client_at_del</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015-2021, Marius Lindauer, Katharina Eggensperger, Matthias Feurer, André Biedenkapp, Difan Deng, Carolin Benjamins, René Sass and Frank Hutter.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>